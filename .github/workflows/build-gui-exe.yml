name: Build GUI EXE

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller aiohttp oss2
    
    - name: Build GUI EXE
      run: |
        pyinstaller --onefile --windowed `
          --name="ProxyChecker" `
          --hidden-import=aiohttp `
          --hidden-import=asyncio `
          --collect-all aiohttp `
          proxy_checker.py
    
    - name: Package release
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item "dist\ProxyChecker.exe" "release\"
        Copy-Item "README.md" "release\"
        Copy-Item "proxies_example.txt" "release\"
        
        @"
================================================================================
  Proxy Checker - GUI Edition
================================================================================

QUICK START:
  1. Double click ProxyChecker.exe
  2. Import or paste proxy list
  3. Click Start Check
  4. View results

PROXY FORMAT:
  192.168.1.1:8080
  http://192.168.1.2:8080
  socks5://192.168.1.3:1080

See proxies_example.txt for examples.
================================================================================
"@ | Out-File -FilePath "release\QuickStart.txt" -Encoding UTF8
        
        Compress-Archive -Path "release\*" -DestinationPath "ProxyChecker.zip"
    
    - name: Upload to Alibaba Cloud OSS
      env:
        OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
        OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      run: |
        python -c @"
        import oss2
        import os
        from datetime import datetime
        
        # Get credentials from environment
        access_key_id = os.environ.get('OSS_ACCESS_KEY_ID')
        access_key_secret = os.environ.get('OSS_ACCESS_KEY_SECRET')
        
        if not access_key_id or not access_key_secret:
            print('Warning: OSS credentials not set, skipping upload')
            exit(0)
        
        auth = oss2.Auth(access_key_id, access_key_secret)
        bucket = oss2.Bucket(auth, 'oss-cn-shenzhen.aliyuncs.com', 'whsm-oss')
        
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        oss_key = f'tools/ProxyChecker_GUI_{timestamp}.zip'
        
        file_size = os.path.getsize('ProxyChecker.zip') / 1024 / 1024
        print(f'Uploading to OSS... ({file_size:.2f} MB)')
        
        with open('ProxyChecker.zip', 'rb') as f:
            bucket.put_object(oss_key, f)
        
        url = bucket.sign_url('GET', oss_key, 24 * 3600)
        
        print()
        print('=' * 80)
        print('Upload Successful!')
        print('=' * 80)
        print('Download URL (valid for 24 hours):')
        print(url)
        print('=' * 80)
        
        with open('download_url.txt', 'w') as f:
            f.write(url)
        "@
    
    - name: Upload GitHub Artifact
      uses: actions/upload-artifact@v3
      with:
        name: ProxyChecker-GUI
        path: ProxyChecker.zip
        retention-days: 7
    
    - name: Display download info
      run: |
        echo "=========================================="
        echo "Build completed successfully!"
        echo "=========================================="
        echo ""
        echo "Download from:"
        echo "1. GitHub Artifacts (above)"
        if (Test-Path download_url.txt) {
          echo "2. OSS URL:"
          Get-Content download_url.txt
        }
