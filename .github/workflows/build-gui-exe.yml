name: Build Windows EXE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller aiohttp
    
    - name: Test import
      run: python -c "import tkinter; import aiohttp; print('Imports OK')"
    
    - name: Create spec file
      run: |
        echo "# -*- mode: python ; coding: utf-8 -*-" > proxy_checker.spec
        echo "a = Analysis(" >> proxy_checker.spec
        echo "    ['proxy_checker.py']," >> proxy_checker.spec
        echo "    pathex=[]," >> proxy_checker.spec
        echo "    binaries=[]," >> proxy_checker.spec
        echo "    datas=[]," >> proxy_checker.spec
        echo "    hiddenimports=['aiohttp', 'asyncio', 'tkinter']," >> proxy_checker.spec
        echo "    hookspath=[]," >> proxy_checker.spec
        echo "    hooksconfig={}," >> proxy_checker.spec
        echo "    runtime_hooks=[]," >> proxy_checker.spec
        echo "    excludes=[]," >> proxy_checker.spec
        echo "    noarchive=False," >> proxy_checker.spec
        echo ")" >> proxy_checker.spec
        echo "pyz = PYZ(a.pure)" >> proxy_checker.spec
        echo "exe = EXE(" >> proxy_checker.spec
        echo "    pyz," >> proxy_checker.spec
        echo "    a.scripts," >> proxy_checker.spec
        echo "    a.binaries," >> proxy_checker.spec
        echo "    a.datas," >> proxy_checker.spec
        echo "    []," >> proxy_checker.spec
        echo "    name='ProxyChecker'," >> proxy_checker.spec
        echo "    debug=False," >> proxy_checker.spec
        echo "    bootloader_ignore_signals=False," >> proxy_checker.spec
        echo "    strip=False," >> proxy_checker.spec
        echo "    upx=True," >> proxy_checker.spec
        echo "    console=False," >> proxy_checker.spec
        echo "    icon=None," >> proxy_checker.spec
        echo ")" >> proxy_checker.spec
    
    - name: Build with spec
      run: pyinstaller proxy_checker.spec
    
    - name: Package
      run: |
        mkdir release
        copy dist\ProxyChecker.exe release\
        copy README.md release\
        copy proxies_example.txt release\
    
    - uses: actions/upload-artifact@v3
      with:
        name: ProxyChecker-Windows
        path: release/
